<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Шежіре Онлайн</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css" />
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:0; }
header { background:#1f2937; color:white; padding:15px; font-size:22px; text-align:center; font-weight:bold; }
button { margin:10px 20px; padding:10px 15px; font-weight:bold; border:none; border-radius:5px; background:#1f2937; color:white; cursor:pointer; }
button:hover { background:#111827; }
#treeContainer { width:100%; height:80vh; overflow:auto; margin-top:10px; }
.node { border-radius:12px; padding:10px 20px; font-weight:bold; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.2); cursor:pointer; }
.green { background:#2ecc71; color:white; }
.blue { background:#3498db; color:white; cursor: default; }
</style>
</head>
<body>

<header>Шежіре Онлайн</header>
<button id="resetBtn">Сбросить дерево</button>
<div id="treeContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzPSTf_4Tdq4xq8C1pwBYrx33F28MOEYKhwgVFcJ4TP5LYFKhhCaQ8IR44EFkadCW6U/exec";
let originalTree = null;

// Загрузка данных
async function loadTree() {
    const res = await fetch(API_URL);
    const people = await res.json();

    const map = {};
    people.forEach(p => map[p.id] = {...p, children: []});
    let root = null;
    people.forEach(p => {
        if(p.father_id === "" || p.father_id === null) root = map[p.id];
        else if(map[p.father_id]) map[p.father_id].children.push(map[p.id]);
    });

    if(!root){ document.getElementById("treeContainer").innerText="Ошибка: не найден главный предок"; return; }

    originalTree = buildTreantNode(root);
    renderTree(originalTree);
}

// Рекурсивная функция для Treant.js с разворачиваемыми узлами
function buildTreantNode(person){
    const node = {
        text: { name: person.name },
        HTMLclass: person.color,
        children: [],
        _children: []
    };
    if(person.children && person.children.length > 0){
        node._children = person.children.map(c => buildTreantNode(c));
        node.children = []; // свернуто изначально
    }
    return node;
}

// Рендер Treant.js
let chart = null;
function renderTree(nodeStructure){
    if(chart){ document.getElementById("treeContainer").innerHTML=""; chart=null; }

    chart = new Treant({
        chart:{
            container:"#treeContainer",
            rootOrientation:"WEST",
            nodeAlign:"BOTTOM",
            connectors:{ type:"step" },
            scrollbar:"fancy"
        },
        nodeStructure: nodeStructure
    });

    // Навешиваем клики после небольшой задержки, чтобы Treant успел создать DOM
    setTimeout(() => attachClicks(nodeStructure), 50);
}

// Навешиваем клики на узлы с детьми
function attachClicks(node){
    if(node._children && node._children.length > 0){
        const el = node.node;
        if(el){
            el.style.cursor = "pointer";
            el.onclick = () => {
                if(node.children.length === 0){
                    node.children = node._children;
                } else {
                    node.children = [];
                }
                renderTree(originalTree);
            }
        }
        node._children.forEach(attachClicks);
        node.children.forEach(attachClicks);
    }
}

// Кнопка сброса дерева
document.getElementById("resetBtn").onclick = () => renderTree(originalTree);

loadTree();
</script>
</body>
</html>
