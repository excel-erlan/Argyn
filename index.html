<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Шежіре Онлайн</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; margin:0; padding:0; }
header { background: #1f2937; color: white; padding: 15px; font-size: 20px; text-align: center; font-weight: bold; }
#treeContainer { padding: 20px; overflow-x: auto; white-space: nowrap; display:flex; align-items:flex-start; position:relative;}
.level { display: inline-block; vertical-align: top; margin-right: 40px; position: relative; }
.person { padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; font-weight: bold; text-align: center; min-width: 140px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: 0.2s; position: relative; }
.person:hover { transform: scale(1.05); }
.green { background: #2ecc71; color: white; }
.blue { background: #3498db; color: white; cursor: default; }
.selected { border: 3px solid #ffcc00; }
.connector { position:absolute; width:2px; background:#555; z-index:-1; }
button { margin: 10px 20px; padding:10px 15px; font-weight:bold; border:none; border-radius:5px; background:#1f2937; color:white; cursor:pointer; }
button:hover { background:#111827; }
</style>
</head>
<body>

<header>Шежіре Онлайн</header>
<div>
<button id="resetBtn">Сбросить дерево</button>
</div>
<div id="treeContainer"></div>
<div id="info">Нажми на зелёного человека чтобы открыть его потомков ➜</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzPSTf_4Tdq4xq8C1pwBYrx33F28MOEYKhwgVFcJ4TP5LYFKhhCaQ8IR44EFkadCW6U/exec";

let people = [];
let expanded = {};
let rootId = null;

async function loadData() {
    const res = await fetch(API_URL);
    people = await res.json();
    // автоматическое определение цвета по наличию детей
    people.forEach(p => {
        p.hasChildren = people.some(c => String(c.father_id) === String(p.id));
    });
    const root = people.find(p => p.father_id === "" || p.father_id === null);
    if(!root){ document.getElementById("info").innerText="Ошибка: корень не найден"; return; }
    rootId = root.id;
    showTree(rootId);
}

function getChildren(fatherId) {
    return people.filter(p => String(p.father_id) === String(fatherId));
}

// строим дерево рекурсивно с линиями
function showTree(startId){
    const container = document.getElementById("treeContainer");
    container.innerHTML="";
    container.style.position="relative";

    function buildLevel(personId, parentDiv, parentRect){
        const person = people.find(p => String(p.id) === String(personId));
        if(!person) return;

        const div = document.createElement("div");
        div.className="person " + (person.hasChildren ? "green":"blue");
        div.innerText = person.name;
        div.dataset.id = person.id;

        if(expanded[person.id]) div.classList.add("selected");

        parentDiv.appendChild(div);

        // кликаем на зеленого
        if(person.hasChildren){
            div.onclick = ()=>{
                expanded[person.id] = !expanded[person.id];
                showTree(rootId);
            }
        }

        // строим детей
        if(expanded[person.id]){
            const children = getChildren(person.id);
            if(children.length>0){
                const childLevel = document.createElement("div");
                childLevel.className="level";
                parentDiv.appendChild(childLevel);

                children.forEach(c=>{
                    buildLevel(c.id, childLevel, div.getBoundingClientRect());
                });

                // рисуем линии
                children.forEach(c=>{
                    const cDiv = childLevel.querySelector(`[data-id='${c.id}']`);
                    if(cDiv){
                        const line = document.createElement("div");
                        line.className="connector";
                        const parentPos = div.getBoundingClientRect();
                        const childPos = cDiv.getBoundingClientRect();
                        // позиционирование линии
                        line.style.left = (parentDiv.offsetLeft + div.offsetWidth) + "px";
                        line.style.top = (parentDiv.offsetTop + div.offsetHeight/2) + "px";
                        line.style.height = (childDivPos(childDiv=cDiv) - parentDiv.offsetTop - div.offsetHeight/2)+"px";
                        container.appendChild(line);
                    }
                });
            }
        }
    }

    function childDivPos(childDiv){
        const rect = childDiv.getBoundingClientRect();
        return rect.top + rect.height/2 + window.scrollY;
    }

    const mainLevel = document.createElement("div");
    mainLevel.className="level";
    buildLevel(startId, mainLevel, null);
    container.appendChild(mainLevel);

    const selectedPerson = people.find(p=>String(p.id)===String(startId));
    document.getElementById("info").innerText="Показана ветка: "+selectedPerson.name;
}

// кнопка сброса
document.getElementById("resetBtn").onclick=()=>{
    expanded={};
    showTree(rootId);
}

loadData();
</script>

</body>
</html>
